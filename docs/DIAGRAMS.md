# Visual Diagrams: Understanding the System

This document provides ASCII and conceptual diagrams to help visualize the system architecture and data flows.

## ğŸ“Š Table of Contents

1. [The Dual-Write Problem](#the-dual-write-problem)
2. [Outbox Pattern Solution](#outbox-pattern-solution)
3. [CDC Architecture](#cdc-architecture)
4. [Retry Flow Diagram](#retry-flow-diagram)
5. [Actor Supervision Tree](#actor-supervision-tree)
6. [Circuit Breaker State Machine](#circuit-breaker-state-machine)
7. [Complete Data Flow](#complete-data-flow)
8. [Failure Scenarios](#failure-scenarios)

---

## The Dual-Write Problem

### âŒ Naive Approach (Problematic)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Service    â”‚
â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ create_order(order)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                         â”‚
â”‚  1. Save to Database                    â”‚
â”‚     â”œâ”€â–º INSERT INTO orders ...          â”‚
â”‚     â””â”€â–º âœ… SUCCESS                      â”‚
â”‚                                         â”‚
â”‚  2. Publish to Message Queue            â”‚
â”‚     â”œâ”€â–º publish(OrderCreated)           â”‚
â”‚     â””â”€â–º âŒ NETWORK TIMEOUT              â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Result:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Database       â”‚     â”‚  Message Queue   â”‚
â”‚                  â”‚     â”‚                  â”‚
â”‚  âœ… Order saved  â”‚     â”‚  âŒ No event     â”‚
â”‚                  â”‚     â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PROBLEM: Inconsistent state!
- Order exists in database
- Downstream services never notified
- Inventory not updated
- Customer not emailed
```

### Timing Diagram: Failure Scenarios

```
Timeline: Naive Dual-Write Approach

Scenario 1: Database fails
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Service     â”‚ DB Write    Publish
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0: Start   â”‚          â”‚
T1: Write   â”‚ âŒ FAIL  â”‚ (not reached)
T2: End     â”‚          â”‚
Result: Consistent (no data, no event) âœ…

Scenario 2: Message Queue fails
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Service     â”‚ DB Write    Publish
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0: Start   â”‚          â”‚
T1: Write   â”‚ âœ… SUCCESSâ”‚
T2: Publish â”‚          â”‚ âŒ FAIL
T3: End     â”‚          â”‚
Result: INCONSISTENT âŒ
  DB: Order exists
  MQ: No event

Scenario 3: Network timeout
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Service     â”‚ DB Write    Publish
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0: Start   â”‚          â”‚
T1: Write   â”‚ âœ… SUCCESSâ”‚
T2: Publish â”‚          â”‚ â³ TIMEOUT
T3: Retry?  â”‚          â”‚ ??? UNKNOWN STATE
Result: INCONSISTENT âŒ
  DB: Order exists
  MQ: Maybe published (we don't know!)
```

---

## Outbox Pattern Solution

### âœ… Correct Approach

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Service    â”‚
â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ create_order(order)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Transactional Batch Write            â”‚
â”‚                                             â”‚
â”‚  BEGIN BATCH;                               â”‚
â”‚    INSERT INTO orders ...;                  â”‚
â”‚    INSERT INTO outbox_messages ...;         â”‚
â”‚  END BATCH;                                 â”‚
â”‚                                             â”‚
â”‚  Result: âœ… Both succeed or both fail       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ScyllaDB (Single Database)          â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  orders        â”‚  â”‚ outbox_messages  â”‚   â”‚
â”‚  â”‚                â”‚  â”‚                  â”‚   â”‚
â”‚  â”‚  id: UUID      â”‚  â”‚  id: UUID        â”‚   â”‚
â”‚  â”‚  customer_id   â”‚  â”‚  aggregate_id â”€â”€â”€â”¼â”€â”€â”€â”¤
â”‚  â”‚  items         â”‚  â”‚  event_type      â”‚   â”‚
â”‚  â”‚  status        â”‚  â”‚  payload (JSON)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ CDC Stream (automatic)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CDC Stream Processor â”‚
â”‚  (Separate Process)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Publish events
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Redpanda/Kafka     â”‚
â”‚   (Message Queue)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Timing Diagram: Outbox Pattern

```
Timeline: Transactional Outbox Pattern

Scenario 1: Happy path
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Service         â”‚ Batch Write     CDC Processor    Publish
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0: Start       â”‚              â”‚              â”‚
T1: Batch write â”‚ âœ… SUCCESS   â”‚              â”‚
T2: CDC detects â”‚              â”‚ âœ… Received  â”‚
T3: Publish     â”‚              â”‚              â”‚ âœ… SUCCESS
Result: Consistent âœ…

Scenario 2: Database fails
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Service         â”‚ Batch Write     CDC Processor    Publish
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0: Start       â”‚              â”‚              â”‚
T1: Batch write â”‚ âŒ FAIL      â”‚ (no event)   â”‚ (not reached)
T2: End         â”‚              â”‚              â”‚
Result: Consistent (no data, no event) âœ…

Scenario 3: Message Queue fails
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Service         â”‚ Batch Write     CDC Processor    Publish
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0: Start       â”‚              â”‚              â”‚
T1: Batch write â”‚ âœ… SUCCESS   â”‚              â”‚
T2: CDC detects â”‚              â”‚ âœ… Received  â”‚
T3: Publish     â”‚              â”‚              â”‚ âŒ FAIL
T4: Retry 1     â”‚              â”‚              â”‚ âŒ FAIL
T5: Retry 2     â”‚              â”‚              â”‚ âŒ FAIL
T6: DLQ store   â”‚              â”‚ âœ… DLQ saved â”‚
T7: Later       â”‚              â”‚ Manual retry â”‚ âœ… SUCCESS
Result: Eventually consistent âœ…
  DB: Order + outbox message exist
  DLQ: Event stored for manual handling
  Later: Event successfully published
```

---

## CDC Architecture

### How CDC Works in ScyllaDB

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Application Layer                    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ OrderActor  â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚         â”‚                                                â”‚
â”‚         â”‚ Batch INSERT                                  â”‚
â”‚         â–¼                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ScyllaDB Layer                        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚         Base Table: outbox_messages          â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚      â”‚
â”‚  â”‚  â”‚ INSERT INTO outbox_messages ...      â”‚   â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚          â”‚                                               â”‚
â”‚          â”‚ (CDC enabled)                                â”‚
â”‚          â”‚ Automatic replication                        â”‚
â”‚          â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚      Hidden CDC Log Tables (per stream)      â”‚      â”‚
â”‚  â”‚                                              â”‚      â”‚
â”‚  â”‚  Stream 0: [row1, row2, row3, ...]          â”‚      â”‚
â”‚  â”‚  Stream 1: [row4, row5, row6, ...]          â”‚      â”‚
â”‚  â”‚  Stream 2: [row7, row8, row9, ...]          â”‚      â”‚
â”‚  â”‚  ...                                         â”‚      â”‚
â”‚  â”‚                                              â”‚      â”‚
â”‚  â”‚  Each stream = subset of partition tokens   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚          â”‚                                               â”‚
â”‚          â”‚ Streams organized by VNode                   â”‚
â”‚          â–¼                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ CDC Library reads streams
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CDC Stream Processor Layer                 â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚       CDCLogReader (from scylla-cdc)        â”‚       â”‚
â”‚  â”‚                                             â”‚       â”‚
â”‚  â”‚  â€¢ Discovers CDC streams                   â”‚       â”‚
â”‚  â”‚  â€¢ Creates consumers per stream            â”‚       â”‚
â”‚  â”‚  â€¢ Handles generation changes              â”‚       â”‚
â”‚  â”‚  â€¢ Manages checkpointing                   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚           â”‚        â”‚        â”‚        â”‚                  â”‚
â”‚           â–¼        â–¼        â–¼        â–¼                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚     â”‚Consumer â”‚ â”‚Consumer â”‚ â”‚Consumer â”‚ ... (parallel) â”‚
â”‚     â”‚ Stream0 â”‚ â”‚ Stream1 â”‚ â”‚ Stream2 â”‚               â”‚
â”‚     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â”‚
â”‚          â”‚           â”‚           â”‚                      â”‚
â”‚          â”‚ consume_cdc()         â”‚                      â”‚
â”‚          â–¼           â–¼           â–¼                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚     â”‚  OutboxCDCConsumer               â”‚               â”‚
â”‚     â”‚  â€¢ Extract event data            â”‚               â”‚
â”‚     â”‚  â€¢ Retry with backoff            â”‚               â”‚
â”‚     â”‚  â€¢ Send to DLQ on failure        â”‚               â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                    â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Publish events
                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Redpanda/Kafka  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CDC Stream Distribution

```
Partition Token Range: [0 ... 2^64-1]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ScyllaDB Cluster                        â”‚
â”‚                                                      â”‚
â”‚  Node 1                 Node 2                Node 3 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚ Tokens:  â”‚          â”‚ Tokens:  â”‚         â”‚ Tokens:  â”‚
â”‚  â”‚ 0 - 33%  â”‚          â”‚ 33% - 66%â”‚         â”‚ 66% - 100%â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚      â”‚                     â”‚                     â”‚
â”‚      â”‚ CDC enabled         â”‚ CDC enabled         â”‚ CDC enabled
â”‚      â–¼                     â–¼                     â–¼
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚ Stream 0 â”‚          â”‚ Stream 1 â”‚         â”‚ Stream 2 â”‚
â”‚  â”‚ Stream 3 â”‚          â”‚ Stream 4 â”‚         â”‚ Stream 5 â”‚
â”‚  â”‚   ...    â”‚          â”‚   ...    â”‚         â”‚   ...    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚                     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                     â”‚
                 â–¼                     â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Consumer Factory â”‚  â”‚ Consumer Factory â”‚
       â”‚   (Instance 1)   â”‚  â”‚   (Instance 2)   â”‚
       â”‚                  â”‚  â”‚                  â”‚
       â”‚ â€¢ Reads subset   â”‚  â”‚ â€¢ Reads subset   â”‚
       â”‚   of streams     â”‚  â”‚   of streams     â”‚
       â”‚ â€¢ Parallel       â”‚  â”‚ â€¢ Parallel       â”‚
       â”‚   processing     â”‚  â”‚   processing     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Key Benefits:
â€¢ Parallel processing across streams
â€¢ Horizontal scalability
â€¢ Fault isolation
â€¢ Load balancing
```

---

## Retry Flow Diagram

### Retry with Exponential Backoff

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Retry State Machine                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

State: ATTEMPT_1
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Time: T0
Delay: 0ms (immediate)
â”‚
â”œâ”€â–º Execute operation()
â”‚
â”œâ”€â–º Result?
â”‚   â”‚
â”‚   â”œâ”€â–º âœ… Success
â”‚   â”‚   â””â”€â–º Return RetryResult::Success
â”‚   â”‚
â”‚   â””â”€â–º âŒ Failure
â”‚       â”‚
â”‚       â”œâ”€â–º is_transient()?
â”‚       â”‚   â”‚
â”‚       â”‚   â”œâ”€â–º No (permanent)
â”‚       â”‚   â”‚   â””â”€â–º Return RetryResult::PermanentFailure
â”‚       â”‚   â”‚
â”‚       â”‚   â””â”€â–º Yes (transient)
â”‚       â”‚       â”‚
â”‚       â”‚       â””â”€â–º Sleep 100ms
â”‚                   â”‚
â”‚                   â–¼
State: ATTEMPT_2
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Time: T0 + 100ms
Delay: 100ms
â”‚
â”œâ”€â–º Execute operation()
â”‚
â”œâ”€â–º Result?
â”‚   â”‚
â”‚   â”œâ”€â–º âœ… Success
â”‚   â”‚   â””â”€â–º Return RetryResult::Success
â”‚   â”‚
â”‚   â””â”€â–º âŒ Failure (transient)
â”‚       â”‚
â”‚       â””â”€â–º Sleep 200ms (100ms * 2.0)
â”‚           â”‚
â”‚           â–¼
State: ATTEMPT_3
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Time: T0 + 300ms
Delay: 200ms
â”‚
â”œâ”€â–º Execute operation()
â”‚
â”œâ”€â–º Result?
â”‚   â”‚
â”‚   â”œâ”€â–º âœ… Success
â”‚   â”‚   â””â”€â–º Return RetryResult::Success
â”‚   â”‚
â”‚   â””â”€â–º âŒ Failure (transient)
â”‚       â”‚
â”‚       â””â”€â–º Sleep 400ms (200ms * 2.0)
â”‚           â”‚
â”‚           â–¼
State: ATTEMPT_4
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Time: T0 + 700ms
Delay: 400ms
â”‚
â”œâ”€â–º Execute operation()
â”‚
â”œâ”€â–º Result?
â”‚   â”‚
â”‚   â”œâ”€â–º âœ… Success
â”‚   â”‚   â””â”€â–º Return RetryResult::Success
â”‚   â”‚
â”‚   â””â”€â–º âŒ Failure (transient)
â”‚       â”‚
â”‚       â””â”€â–º Sleep 500ms (min(400ms * 2.0, 500ms) = 500ms)
â”‚           â”‚
â”‚           â–¼
State: ATTEMPT_5 (FINAL)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Time: T0 + 1200ms
Delay: 500ms (capped)
â”‚
â”œâ”€â–º Execute operation()
â”‚
â”œâ”€â–º Result?
â”‚   â”‚
â”‚   â”œâ”€â–º âœ… Success
â”‚   â”‚   â””â”€â–º Return RetryResult::Success
â”‚   â”‚
â”‚   â””â”€â–º âŒ Failure (transient)
â”‚       â”‚
â”‚       â””â”€â–º Max attempts reached
â”‚           â”‚
â”‚           â””â”€â–º Return RetryResult::Failed
â”‚               â”‚
â”‚               â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   DLQ   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Total Time: 1.2 seconds
Total Attempts: 5
Backoff Sequence: 0ms, 100ms, 200ms, 400ms, 500ms
```

### Retry Decision Tree

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Operation  â”‚
                    â”‚   Execute   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Success?   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                         â”‚
              â–¼                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   YES   â”‚              â”‚   NO    â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
              â”‚                        â”‚
              â–¼                        â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Return       â”‚        â”‚  Is Error     â”‚
      â”‚ Success(T)   â”‚        â”‚  Transient?   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚                         â”‚
                         â–¼                         â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   YES   â”‚              â”‚   NO    â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚                        â”‚
                         â–¼                        â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  Attempts <    â”‚      â”‚ Return Permanent â”‚
                â”‚  Max?          â”‚      â”‚ Failure(E)       â”‚
                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â–¼                         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   YES   â”‚              â”‚   NO    â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                        â”‚
        â–¼                        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Sleep with   â”‚      â”‚ Return       â”‚
   â”‚ Backoff      â”‚      â”‚ Failed(E)    â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚
          â–¼                     â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Retry        â”‚      â”‚   Send to    â”‚
   â”‚ (loop back)  â”‚      â”‚     DLQ      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Actor Supervision Tree

```
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚     Actix System Root          â”‚
                   â”‚  (Manages entire actor system) â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â”‚ spawns
                                   â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚    CoordinatorActor            â”‚
                   â”‚  (Supervisor)                  â”‚
                   â”‚                                â”‚
                   â”‚  Responsibilities:             â”‚
                   â”‚  â€¢ Manages child lifecycles    â”‚
                   â”‚  â€¢ Handles graceful shutdown   â”‚
                   â”‚  â€¢ Coordinates health checks   â”‚
                   â”‚  â€¢ Implements restart policies â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â”‚ supervises
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                  â”‚                  â”‚
                â–¼                  â–¼                  â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ HealthCheckActorâ”‚  â”‚  DlqActor    â”‚  â”‚  OrderActor  â”‚
     â”‚                 â”‚  â”‚              â”‚  â”‚              â”‚
     â”‚ â€¢ Monitors CB   â”‚  â”‚ â€¢ Stores     â”‚  â”‚ â€¢ Processes  â”‚
     â”‚ â€¢ Checks health â”‚  â”‚   failed     â”‚  â”‚   commands   â”‚
     â”‚ â€¢ Reports       â”‚  â”‚   messages   â”‚  â”‚ â€¢ Transact   â”‚
     â”‚   status        â”‚  â”‚ â€¢ Provides   â”‚  â”‚   writes     â”‚
     â”‚                 â”‚  â”‚   stats      â”‚  â”‚              â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â”‚ writes to
                                                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         ScyllaDB                       â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚  â”‚  orders    â”‚  â”‚ outbox_messages  â”‚ â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                                                â”‚ CDC stream
                                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    CdcStreamProcessor                  â”‚
                    â”‚                                        â”‚
                    â”‚  â€¢ Consumes CDC events                 â”‚
                    â”‚  â€¢ Retries with backoff                â”‚
                    â”‚  â€¢ Sends to DLQ on failure             â”‚
                    â”‚                                        â”‚
                    â”‚  Dependencies:                         â”‚
                    â”‚  â”œâ”€â–º RedpandaClient (with CB)          â”‚
                    â”‚  â””â”€â–º DlqActor (for failures)           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ publishes to
                                      â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         Redpanda/Kafka                 â”‚
                    â”‚                                        â”‚
                    â”‚  â€¢ OrderCreated topic                  â”‚
                    â”‚  â€¢ OrderUpdated topic                  â”‚
                    â”‚  â€¢ OrderCancelled topic                â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Supervision Policies:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Actor                Policy               Action on Failure
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CoordinatorActor     N/A (root)          System shutdown
HealthCheckActor     Resume              Log error, continue
DlqActor             Resume              Log error, continue
OrderActor           Restart             Recreate actor
CdcStreamProcessor   Restart             Recreate consumer

Message Flow:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. User â†’ OrderActor (CreateOrder message)
2. OrderActor â†’ ScyllaDB (batched write)
3. ScyllaDB â†’ CdcStreamProcessor (CDC stream)
4. CdcStreamProcessor â†’ RedpandaClient (publish)
5. On failure â†’ DlqActor (store failed message)
6. HealthCheckActor â†’ All actors (periodic health checks)
```

---

## Circuit Breaker State Machine

```
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚    CLOSED    â”‚
                  â”‚   (Normal)   â”‚
                  â”‚              â”‚
                  â”‚ â€¢ All calls  â”‚
                  â”‚   allowed    â”‚
                  â”‚ â€¢ Track      â”‚
                  â”‚   failures   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ failure_count++
                         â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                     â”‚
     â”‚ failure_count >= threshold (5)?    â”‚
     â”‚                                     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ YES
              â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚     OPEN     â”‚
       â”‚  (Blocking)  â”‚
       â”‚              â”‚
       â”‚ â€¢ All calls  â”‚
       â”‚   rejected   â”‚
       â”‚ â€¢ Fast fail  â”‚
       â”‚ â€¢ Start      â”‚
       â”‚   timeout    â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ wait timeout (30s)
              â”‚
              â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   HALF-OPEN  â”‚
       â”‚   (Testing)  â”‚
       â”‚              â”‚
       â”‚ â€¢ Limited    â”‚
       â”‚   calls      â”‚
       â”‚ â€¢ Test       â”‚
       â”‚   recovery   â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ execute test calls
              â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                  â”‚
     â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUCCESS â”‚                        â”‚ FAILURE â”‚
â”‚   ?     â”‚                        â”‚   ?     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                  â”‚
     â”‚ success_count >= 3?              â”‚
     â”‚                                  â”‚
     â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   YES   â”‚                        â”‚   NO    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                  â”‚
     â”‚ Reset failure_count              â”‚
     â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Transition   â”‚              â”‚ Transition   â”‚
â”‚ to CLOSED    â”‚              â”‚ to OPEN      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
            Resume operations

State Transition Table:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
From State  â”‚ Event              â”‚ To State    â”‚ Action
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CLOSED      â”‚ failure_count >= 5 â”‚ OPEN        â”‚ Block calls
CLOSED      â”‚ success            â”‚ CLOSED      â”‚ Reset counter
OPEN        â”‚ timeout elapsed    â”‚ HALF_OPEN   â”‚ Allow test
OPEN        â”‚ call attempted     â”‚ OPEN        â”‚ Reject fast
HALF_OPEN   â”‚ success (count=3)  â”‚ CLOSED      â”‚ Resume
HALF_OPEN   â”‚ any failure        â”‚ OPEN        â”‚ Block again

Timing Example:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
T0:    CLOSED - call succeeds (failure_count = 0)
T1:    CLOSED - call fails (failure_count = 1)
T2:    CLOSED - call fails (failure_count = 2)
T3:    CLOSED - call fails (failure_count = 3)
T4:    CLOSED - call fails (failure_count = 4)
T5:    CLOSED - call fails (failure_count = 5)
T6:    â†’ OPEN (threshold reached)
T7-35: OPEN - all calls rejected immediately
T36:   â†’ HALF_OPEN (30s timeout elapsed)
T37:   HALF_OPEN - test call succeeds (success_count = 1)
T38:   HALF_OPEN - test call succeeds (success_count = 2)
T39:   HALF_OPEN - test call succeeds (success_count = 3)
T40:   â†’ CLOSED (recovery confirmed)
```

---

## Complete Data Flow

### End-to-End: Order Creation to Event Delivery

```
Step 1: User Request
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User   â”‚ POST /orders {"customer_id": "...", "items": [...]}
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HTTP Handler    â”‚
â”‚  (Not shown in   â”‚
â”‚   this project)  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ Send CreateOrder message
      â–¼

Step 2: Actor Processing
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              OrderActor::handle()                    â”‚
â”‚                                                      â”‚
â”‚  1. Generate order_id = UUID::new_v4()              â”‚
â”‚  2. Create OrderCreatedEvent                        â”‚
â”‚  3. Call persist_with_outbox()                      â”‚
â”‚     â”œâ”€â–º Prepare batch                               â”‚
â”‚     â”œâ”€â–º Add order INSERT                            â”‚
â”‚     â”œâ”€â–º Add outbox INSERT                           â”‚
â”‚     â””â”€â–º Execute atomically                          â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼

Step 3: Database Write
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ScyllaDB                           â”‚
â”‚                                                      â”‚
â”‚  BEGIN BATCH;                                        â”‚
â”‚    INSERT INTO orders                                â”‚
â”‚      (id, customer_id, items, status, ...)          â”‚
â”‚    VALUES (?, ?, ?, 'pending', ...);                 â”‚
â”‚                                                      â”‚
â”‚    INSERT INTO outbox_messages                       â”‚
â”‚      (id, aggregate_id, event_type, payload, ...)   â”‚
â”‚    VALUES (?, ?, 'OrderCreated', '{"order_id":...}',â”‚
â”‚             ...);                                    â”‚
â”‚  APPLY BATCH;                                        â”‚
â”‚                                                      â”‚
â”‚  âœ… Both writes succeed atomically                   â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ Automatically triggers CDC
                   â–¼

Step 4: CDC Capture (< 100ms latency)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            CDC Hidden Log Tables                     â”‚
â”‚                                                      â”‚
â”‚  Stream 0: [..., new_row, ...]                      â”‚
â”‚  Stream 1: [...]                                     â”‚
â”‚  Stream 2: [...]                                     â”‚
â”‚                                                      â”‚
â”‚  new_row = {                                         â”‚
â”‚    operation: "RowInsert",                           â”‚
â”‚    stream_id: 0,                                     â”‚
â”‚    data: {                                           â”‚
â”‚      id: UUID,                                       â”‚
â”‚      aggregate_id: UUID,                             â”‚
â”‚      event_type: "OrderCreated",                     â”‚
â”‚      payload: '{"order_id": "..."}',                 â”‚
â”‚      created_at: TIMESTAMP                           â”‚
â”‚    }                                                 â”‚
â”‚  }                                                   â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ CDC library polls streams
                   â–¼

Step 5: Consumer Processing
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     OutboxCDCConsumer::consume_cdc()                 â”‚
â”‚                                                      â”‚
â”‚  1. Receive CDCRow                                   â”‚
â”‚  2. Extract event data                               â”‚
â”‚     â”œâ”€â–º id                                           â”‚
â”‚     â”œâ”€â–º aggregate_id                                 â”‚
â”‚     â”œâ”€â–º event_type                                   â”‚
â”‚     â””â”€â–º payload                                      â”‚
â”‚                                                      â”‚
â”‚  3. Attempt publish with retry                       â”‚
â”‚     â”œâ”€â–º Attempt 1: immediate                         â”‚
â”‚     â”œâ”€â–º Attempt 2: after 100ms (if failed)          â”‚
â”‚     â”œâ”€â–º Attempt 3: after 200ms (if failed)          â”‚
â”‚     â”œâ”€â–º Attempt 4: after 400ms (if failed)          â”‚
â”‚     â””â”€â–º Attempt 5: after 500ms (if failed)          â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                       â”‚
       â–¼                       â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Success â”‚            â”‚ Failure â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                      â”‚
       â–¼                      â–¼

Step 6a: Success Path
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         RedpandaClient::publish()                    â”‚
â”‚                                                      â”‚
â”‚  Through circuit breaker:                            â”‚
â”‚  1. Check circuit state                              â”‚
â”‚  2. If CLOSED, send to Redpanda                      â”‚
â”‚  3. Update success metrics                           â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Redpanda/Kafka                          â”‚
â”‚                                                      â”‚
â”‚  Topic: OrderCreated                                 â”‚
â”‚  Partition: hash(order_id) % partitions              â”‚
â”‚  Message: {                                          â”‚
â”‚    key: "order_id",                                  â”‚
â”‚    value: '{"order_id": "...", "customer_id": ...}' â”‚
â”‚  }                                                   â”‚
â”‚                                                      â”‚
â”‚  âœ… Event successfully published                     â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Downstream        â”‚
        â”‚  Consumers         â”‚
        â”‚  â€¢ Inventory Svc   â”‚
        â”‚  â€¢ Email Svc       â”‚
        â”‚  â€¢ Analytics       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 6b: Failure Path
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         After 5 failed retry attempts                â”‚
â”‚                                                      â”‚
â”‚  DlqActor::handle(AddToDlq)                         â”‚
â”‚  1. Log error with context                           â”‚
â”‚  2. INSERT INTO dead_letter_queue                    â”‚
â”‚     â”œâ”€â–º Original event data                          â”‚
â”‚     â”œâ”€â–º Error message                                â”‚
â”‚     â”œâ”€â–º Failure count (5)                            â”‚
â”‚     â”œâ”€â–º First failed timestamp                       â”‚
â”‚     â””â”€â–º Last failed timestamp                        â”‚
â”‚                                                      â”‚
â”‚  3. Update DLQ metrics                               â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Alert System      â”‚
        â”‚  â€¢ PagerDuty       â”‚
        â”‚  â€¢ Slack           â”‚
        â”‚  â€¢ Email           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  On-Call Engineer  â”‚
        â”‚  â€¢ Investigate DLQ â”‚
        â”‚  â€¢ Fix root cause  â”‚
        â”‚  â€¢ Replay messages â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Latency Breakdown (Happy Path):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Operation                      Latency
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. User request â†’ Actor        ~1ms
2. Actor processing            ~0.5ms
3. ScyllaDB batch write        ~2-5ms (local)
4. CDC capture                 ~50-100ms
5. Consumer processing         ~1ms
6. Redpanda publish            ~2-5ms (local)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total end-to-end:              ~60-120ms

With retries (worst case):     ~1.2s + base latency
```

---

## Failure Scenarios

### Scenario Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Failure Scenarios and System Response                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Scenario 1: Redpanda Temporary Outage
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Timeline:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0: Order created, batch written to ScyllaDB âœ…
T1: CDC captures change âœ…
T2: Attempt 1: Redpanda connection refused âŒ
T3: Wait 100ms
T4: Attempt 2: Still down âŒ
T5: Wait 200ms
T6: Attempt 3: Still down âŒ
T7: Wait 400ms
T8: Attempt 4: Redpanda recovers! âœ…
Result: Event successfully published after 700ms

Impact:
â”€â”€â”€â”€â”€â”€â”€
â€¢ Order saved: âœ…
â€¢ Event eventually published: âœ…
â€¢ User notified: âœ… (order confirmed)
â€¢ Downstreams notified: âœ… (delayed ~700ms)

Scenario 2: Redpanda Extended Outage
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Timeline:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0: Order created, batch written âœ…
T1: CDC captures change âœ…
T2-T6: All 5 retry attempts fail âŒ
T7: Message sent to DLQ âœ…
T8: Alert triggered ğŸš¨
T9: Engineer investigates
T10: Redpanda fixed
T11: Engineer replays DLQ messages âœ…

Impact:
â”€â”€â”€â”€â”€â”€â”€
â€¢ Order saved: âœ…
â€¢ Event in DLQ: âœ…
â€¢ User notified: âœ… (order confirmed)
â€¢ Downstreams notified: âŒ (waiting on manual replay)
â€¢ SLA: Degraded, but no data loss

Scenario 3: ScyllaDB Write Failure
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Timeline:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0: Attempt batch write
T1: ScyllaDB returns error (timeout/unavailable) âŒ
T2: OrderActor receives error
T3: Returns error to user âŒ

Impact:
â”€â”€â”€â”€â”€â”€â”€
â€¢ Order saved: âŒ
â€¢ Event published: âŒ
â€¢ User notified: âŒ (received error response)
â€¢ System state: Consistent (nothing saved) âœ…

Scenario 4: Partial CDC Processing Failure
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Timeline:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0: 100 orders created
T1: CDC captures all 100 changes âœ…
T2: Consumer processes 50 events successfully âœ…
T3: Redpanda overloaded, circuit breaker opens ğŸ”´
T4: Next 50 events rejected by circuit breaker âŒ
T5: All 50 failed events sent to DLQ âœ…
T6: Circuit breaker timeout (30s)
T7: Circuit breaker enters HALF_OPEN ğŸŸ¡
T8: 3 test events succeed âœ…
T9: Circuit breaker closes ğŸŸ¢
T10: DLQ messages replayed âœ…

Impact:
â”€â”€â”€â”€â”€â”€â”€
â€¢ Orders saved: âœ… (all 100)
â€¢ Events published: âœ… (50 immediate + 50 after recovery)
â€¢ Circuit breaker prevented cascading failure âœ…
â€¢ Total delay for last 50: ~30s

Scenario 5: Consumer Crash
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Timeline:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0: Consumer processing events normally
T1: OOM/panic, consumer crashes â˜ ï¸
T2: Actix supervisor detects failure
T3: Supervisor restarts CdcStreamProcessor â™»ï¸
T4: CDC library resumes from last checkpoint âœ…
T5: Events re-processed (idempotency handles duplicates) âœ…

Impact:
â”€â”€â”€â”€â”€â”€â”€
â€¢ Orders saved: âœ…
â€¢ Events eventually published: âœ…
â€¢ Possible duplicates: Handled by idempotency âœ…
â€¢ Downtime: ~1-2 seconds

Recovery Decision Tree:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  Failure   â”‚
                     â”‚  Detected  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                            â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚                  â”‚
                   â–¼                  â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Transient   â”‚   â”‚  Permanent   â”‚
            â”‚    Error?    â”‚   â”‚    Error?    â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                  â”‚
                   â–¼                  â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚    Retry     â”‚   â”‚    Send to   â”‚
            â”‚ with Backoff â”‚   â”‚     DLQ      â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                  â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
      â”‚                     â”‚         â”‚
      â–¼                     â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Success  â”‚         â”‚ Exhaust  â”‚  â”‚   Alert     â”‚
â”‚ After N  â”‚         â”‚ Retries  â”‚  â”‚  On-Call    â”‚
â”‚ Attempts â”‚         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Send to    â”‚
                    â”‚     DLQ      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

This concludes the diagrams documentation. These visualizations should help understand the system architecture, data flows, and failure handling mechanisms!
